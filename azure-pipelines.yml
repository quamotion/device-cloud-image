jobs:
- job: build
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: |
      sudo apt-get install -y xorriso systemd-container genisoimage
    displayName: Install dependencies

  - script: |
      curl -Lo ubuntu-18.04.1.0-live-server-amd64.iso http://releases.ubuntu.com/18.04.1.0/ubuntu-18.04.1.0-live-server-amd64.iso
      xorriso -osirrox on -indev ubuntu-18.04.1.0-live-server-amd64.iso  -extract / upstream/
      sudo unsquashfs upstream/casper/filesystem.squashfs
    displayName: Download and extract Ubuntu installer

  - script: |
      # https://github.com/systemd/systemd/pull/9024 contains changes to bind mount resolv-conf
      # into the chroot. Available in systemd 239 and above, so that means Ubuntu 18.10 and later.
      sudo rm squashfs-root/etc/resolv.conf
      sudo cp -L /etc/resolv.conf squashfs-root/etc/resolv.conf

      # Copy the scripts inside the RootFS, and execute them
      sudo cp -r scripts/ squashfs-root/root/scripts/
      sudo systemd-nspawn -D squashfs-root/ /root/scripts/prepare-ansible.sh
    displayName: Prepare RootFS

  - script: |
      sudo systemd-nspawn -D squashfs-root/ /root/scripts/apply-role.sh
    displayName: Apply device-farm-node role

  - script: |
      sudo chmod +w extract/casper/filesystem.manifest
      sudo systemd-nspawn -D squashfs-root dpkg-query -W --showformat='${Package} ${Version}\n' | sudo tee upstream/casper/filesystem.manifest
    displayName: Update the manifest

  - script: |
      sudo mksquashfs squashfs-root upstream/casper/filesystem.squashfs -b 1048576
      printf $(sudo du -sx --block-size=1 edit | cut -f1) | sudo tee upstream/casper/filesystem.size
      rm upstream/md5sum.txt
      (cd upstream && find -type f -print0 | sudo xargs -0 md5sum | grep -v isolinux/boot.cat) | sudo tee upstream/md5sum.txt
    displayName: Compress the filesystem

  - script: |
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/iso
      sudo genisoimage -D -r -V "$IMAGE_NAME" -cache-inodes -J -l -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -o $BUILD_ARTIFACTSTAGINGDIRECTORY/quamotion-device-node.iso upstream/

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)/iso'
      artifactName: 'iso'
      publishLocation: 'Container'
    displayName: Publish
